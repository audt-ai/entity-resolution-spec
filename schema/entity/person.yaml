# Person Entity Schema
# Represents a natural person for identity resolution purposes

schema_version: "1.0.0"
entity_type: person
description: |
  A person entity represents a natural person. Identity is established through
  high-specificity identifiers (SSN, passport, etc.) or combinations of
  lower-specificity attributes (name, DOB, address).

fields:
  # Primary key for this entity within the resolution system
  entity_id:
    type: string
    format: uuid
    required: true
    description: System-assigned unique identifier for this entity
    immutable: true

  # High-specificity identifiers (suitable for exact matching)
  identifiers:
    type: object
    description: Government-issued and other high-specificity identifiers
    fields:
      ssn:
        type: string
        format: ssn
        description: US Social Security Number (XXX-XX-XXXX format after normalization)
        sensitivity: high
        validation:
          pattern: "^[0-9]{3}-[0-9]{2}-[0-9]{4}$"
          # Known invalid patterns (advertising, placeholder)
          exclude_patterns:
            - "^000-"
            - "^666-"
            - "^9[0-9]{2}-"
            - "^[0-9]{3}-00-"
            - "^[0-9]{3}-[0-9]{2}-0000$"

      passport_number:
        type: string
        description: Passport number (format varies by country)
        sensitivity: high

      passport_country:
        type: string
        format: iso3166_alpha2
        description: Country that issued the passport (ISO 3166-1 alpha-2)

      passport_expiry:
        type: date
        description: Passport expiration date

      national_id:
        type: string
        description: National identification number (format varies by country)
        sensitivity: high

      national_id_country:
        type: string
        format: iso3166_alpha2
        description: Country that issued the national ID

      drivers_license_number:
        type: string
        description: Driver's license number
        sensitivity: high

      drivers_license_state:
        type: string
        description: State/province that issued the driver's license

  # Name components
  name:
    type: object
    description: Name components for the person
    fields:
      given_name:
        type: string
        description: First name / given name
        max_length: 100

      middle_names:
        type: array
        items:
          type: string
        description: Middle name(s), in order

      family_name:
        type: string
        description: Last name / surname / family name
        max_length: 100

      suffix:
        type: string
        description: Name suffix (Jr., Sr., III, etc.)
        enum:
          - Jr.
          - Sr.
          - II
          - III
          - IV
          - V
          - Esq.
          - PhD
          - MD
          - JD

      prefix:
        type: string
        description: Name prefix / title (Mr., Mrs., Dr., etc.)

      maiden_name:
        type: string
        description: Maiden name if applicable
        max_length: 100

      aliases:
        type: array
        items:
          type: object
          fields:
            given_name:
              type: string
            family_name:
              type: string
            alias_type:
              type: string
              enum:
                - nickname
                - former_name
                - also_known_as
                - stage_name
                - pen_name
        description: Known aliases or alternate names

  # Demographic attributes
  date_of_birth:
    type: date
    format: iso8601_date
    description: Date of birth (YYYY-MM-DD)

  date_of_death:
    type: date
    format: iso8601_date
    description: Date of death if applicable (YYYY-MM-DD)

  gender:
    type: string
    enum:
      - male
      - female
      - other
      - unknown
    description: Gender as recorded in source data

  # Contact information
  contact:
    type: object
    description: Contact information
    fields:
      phones:
        type: array
        items:
          type: object
          fields:
            number:
              type: string
              format: e164
              description: Phone number in E.164 format after normalization
            type:
              type: string
              enum:
                - mobile
                - home
                - work
                - fax
                - unknown
            effective_from:
              type: date
            effective_to:
              type: date

      emails:
        type: array
        items:
          type: object
          fields:
            address:
              type: string
              format: email
              description: Email address (normalized to lowercase)
            type:
              type: string
              enum:
                - personal
                - work
                - unknown
            effective_from:
              type: date
            effective_to:
              type: date

  # Address associations (references to address entities)
  addresses:
    type: array
    items:
      type: object
      fields:
        address_entity_id:
          type: string
          format: uuid
          description: Reference to an address entity
        address_type:
          type: string
          enum:
            - residential
            - mailing
            - work
            - previous
            - unknown
        effective_from:
          type: date
          description: When person became associated with this address
        effective_to:
          type: date
          description: When person stopped being associated with this address
    description: Historical and current address associations

  # Metadata
  metadata:
    type: object
    description: System metadata for the entity
    fields:
      created_at:
        type: datetime
        format: iso8601
        required: true
        immutable: true
        description: When this entity record was created

      updated_at:
        type: datetime
        format: iso8601
        required: true
        description: When this entity record was last updated

      version:
        type: integer
        minimum: 1
        required: true
        description: Version number for optimistic locking

      source_record_ids:
        type: array
        items:
          type: string
          format: uuid
        required: true
        description: References to source records that contributed to this entity

# Validation rules applied to the entity as a whole
validation:
  rules:
    - id: person_val_001
      description: Date of death must be after date of birth
      condition: |
        if date_of_death is not null and date_of_birth is not null:
          date_of_death > date_of_birth

    - id: person_val_002
      description: Passport country must be present if passport number is present
      condition: |
        if identifiers.passport_number is not null:
          identifiers.passport_country is not null

    - id: person_val_003
      description: National ID country must be present if national ID is present
      condition: |
        if identifiers.national_id is not null:
          identifiers.national_id_country is not null

    - id: person_val_004
      description: Driver's license state must be present if license number is present
      condition: |
        if identifiers.drivers_license_number is not null:
          identifiers.drivers_license_state is not null

# Fields used for matching at each tier
matching:
  exact_match_fields:
    - identifiers.ssn
    - identifiers.passport_number + identifiers.passport_country
    - identifiers.national_id + identifiers.national_id_country
    - identifiers.drivers_license_number + identifiers.drivers_license_state

  strong_match_fields:
    - name.given_name + name.family_name + date_of_birth + addresses
    - name.given_name + name.family_name + date_of_birth + contact.phones
    - name.given_name + name.family_name + date_of_birth + contact.emails

  weak_match_fields:
    - name.given_name + name.family_name + addresses
    - name.given_name + name.family_name + date_of_birth

# Fields that indicate conflict when mismatched on otherwise-matching records
conflict_indicators:
  - date_of_birth  # If identifiers match but DOB differs
  - identifiers.ssn  # If other identifiers match but SSN differs

