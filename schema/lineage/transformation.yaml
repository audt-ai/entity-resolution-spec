# Transformation Schema
# Documents all transformations applied to data from source to entity

schema_version: "1.0.0"
description: |
  Transformation records document every change made to data between
  source record ingestion and entity attribute population. This enables
  complete lineage tracing and supports audit requirements.

# Transformation record schema
transformation_record:
  fields:
    transformation_id:
      type: string
      format: uuid
      required: true
      description: Unique identifier for this transformation record
      immutable: true

    # What was transformed
    input:
      type: object
      required: true
      description: The input to this transformation
      fields:
        source_record_id:
          type: string
          format: uuid
          description: Source record this transformation applies to

        entity_id:
          type: string
          format: uuid
          description: Entity ID if transforming entity data

        field_path:
          type: string
          required: true
          description: Path to the field being transformed

        original_value:
          type: string
          required: true
          description: |
            Value before transformation.
            Stored as string representation regardless of original type.

        original_type:
          type: string
          enum:
            - string
            - integer
            - number
            - boolean
            - date
            - datetime
            - array
            - object
            - null
          description: Data type of original value

    # What transformation was applied
    transformation:
      type: object
      required: true
      description: The transformation that was applied
      fields:
        transformation_type:
          type: string
          required: true
          enum:
            - normalization
            - parsing
            - validation
            - enrichment
            - correction
            - derivation
            - formatting
          description: Category of transformation

        transformation_rule_id:
          type: string
          required: true
          description: |
            Identifier for the specific rule applied.
            References normalization spec or transformation rule definition.

        transformation_rule_version:
          type: string
          description: Version of the transformation rule

        description:
          type: string
          description: Human-readable description of what was done

    # Result of transformation
    output:
      type: object
      required: true
      description: The result of this transformation
      fields:
        transformed_value:
          type: string
          required: true
          description: Value after transformation (string representation)

        transformed_type:
          type: string
          enum:
            - string
            - integer
            - number
            - boolean
            - date
            - datetime
            - array
            - object
            - null
          description: Data type of transformed value

        transformation_successful:
          type: boolean
          required: true
          description: Whether the transformation succeeded

        error_message:
          type: string
          description: Error details if transformation failed

        warnings:
          type: array
          items:
            type: string
          description: Non-fatal issues encountered during transformation

    # Metadata
    applied_at:
      type: datetime
      format: iso8601
      required: true
      description: When this transformation was applied

    applied_in_batch_id:
      type: string
      format: uuid
      description: Processing batch this transformation was part of

# Transformation types in detail
transformation_types:
  normalization:
    description: |
      Standardization of values to a canonical form for comparison.
      Does not change semantic meaning, only representation.
    examples:
      - Case normalization (JOHN -> John)
      - Whitespace normalization (multiple spaces to single)
      - Abbreviation expansion (St -> Street)
      - Phone number formatting to E.164
      - Date formatting to ISO 8601
    reversibility: Generally reversible (original preserved)

  parsing:
    description: |
      Breaking a composite value into structured components.
    examples:
      - Address string to structured components
      - Full name to given/family name
      - Phone number to country code + number
    reversibility: Not fully reversible (parsing decisions are documented)

  validation:
    description: |
      Checking value against rules; may mark as invalid or correct.
    examples:
      - SSN format validation
      - Email syntax validation
      - Date range validation
    reversibility: Validation does not change values; flags are added

  enrichment:
    description: |
      Adding derived or looked-up information.
    examples:
      - Country code lookup from country name
      - Postal code validation and correction
      - Geocoding from address
    reversibility: |
      Original values preserved; enriched values are additions.
      Enrichment source is documented.

  correction:
    description: |
      Explicit correction of a known error.
    examples:
      - Typo correction from known mappings
      - State code correction (XY -> NY)
    reversibility: Original preserved; correction reason documented

  derivation:
    description: |
      Computing new values from existing values.
    examples:
      - Age calculation from date of birth
      - Full address string from components
    reversibility: Derivation formula is documented

  formatting:
    description: |
      Changing value format without changing meaning.
    examples:
      - Date display format changes
      - Number formatting (1000 -> 1,000)
    reversibility: Generally reversible

# Transformation rule definition schema
transformation_rule:
  description: |
    Definition of a reusable transformation rule.
    Rules are referenced by transformation records.

  fields:
    rule_id:
      type: string
      required: true
      description: Unique identifier for this rule

    rule_version:
      type: string
      required: true
      description: Version of this rule definition

    transformation_type:
      type: string
      enum:
        - normalization
        - parsing
        - validation
        - enrichment
        - correction
        - derivation
        - formatting
      required: true

    name:
      type: string
      required: true
      description: Human-readable name

    description:
      type: string
      required: true
      description: What this rule does

    applies_to:
      type: object
      description: What this rule applies to
      fields:
        entity_types:
          type: array
          items:
            type: string
            enum:
              - person
              - organization
              - address
        field_paths:
          type: array
          items:
            type: string
          description: Field paths this rule can be applied to

    parameters:
      type: object
      description: Configuration parameters for this rule

    implementation:
      type: object
      description: How the rule is implemented
      fields:
        type:
          type: string
          enum:
            - lookup_table
            - regex_replacement
            - function
            - external_service
          description: Implementation mechanism

        definition:
          type: string
          description: |
            Implementation definition (table name, regex, function name, etc.)

    test_cases:
      type: array
      description: Example inputs and expected outputs
      items:
        type: object
        fields:
          input:
            type: string
          expected_output:
            type: string
          description:
            type: string

    active:
      type: boolean
      default: true
      description: Whether this rule is currently active

    effective_from:
      type: date
      description: When this rule became effective

    effective_to:
      type: date
      description: When this rule was retired (if applicable)

# Transformation chain schema
transformation_chain:
  description: |
    Documents the complete sequence of transformations applied to
    a field value from source to entity.

  fields:
    chain_id:
      type: string
      format: uuid
      required: true

    source_record_id:
      type: string
      format: uuid
      required: true
      description: Starting source record

    entity_id:
      type: string
      format: uuid
      required: true
      description: Resulting entity

    source_field_path:
      type: string
      required: true
      description: Field path in source record

    entity_field_path:
      type: string
      required: true
      description: Field path in entity

    transformations:
      type: array
      items:
        type: string
        format: uuid
      description: |
        Ordered list of transformation_ids applied.
        First transformation takes source value as input;
        each subsequent transformation takes previous output.

    original_value:
      type: string
      description: Value in source record

    final_value:
      type: string
      description: Value in entity

    transformation_count:
      type: integer
      description: Number of transformations applied

# Audit queries supported
audit_capabilities:
  description: |
    The transformation schema supports the following audit queries.

  queries:
    - query: What transformations were applied to this entity field?
      method: |
        1. Find transformation_chain for entity_id + entity_field_path
        2. Retrieve all transformations in chain
        3. Return ordered transformation records

    - query: What was the original source value for this entity field?
      method: |
        1. Find transformation_chain for entity_id + entity_field_path
        2. Return original_value from chain
        3. Or retrieve source_record and extract from raw_data

    - query: Which transformation rule affected this value?
      method: |
        1. Find transformation records for source_record_id + field_path
        2. Return transformation_rule_ids

    - query: What values have been affected by this transformation rule?
      method: |
        1. Query transformation_record by transformation_rule_id
        2. Return list of affected source_record_id + field_path

    - query: Has this transformation rule ever produced errors?
      method: |
        1. Query transformation_record by transformation_rule_id
        2. Filter where transformation_successful = false
        3. Return error summaries

